C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 1   


C51 COMPILER V9.60.7.0, COMPILATION OF MODULE MAIN
OBJECT MODULE PLACED IN .\Objects\main.obj
COMPILER INVOKED BY: F:\keil_5\C51\BIN\C51.EXE main.c OPTIMIZE(8,SPEED) BROWSE INCDIR(..\Driver) DEBUG OBJECTEXTEND PRIN
                    -T(.\Listings\main.lst) TABS(2) OBJECT(.\Objects\main.obj)

line level    source

   1          #include <STC15F2K60S2.H>
   2          
   3          #include "init.h"
   4          #include "led.h"
   5          #include "key.h"
   6          #include "seg.h"
   7          
   8          #include "iic.h"
   9          #include "ultrasonic.h"
  10          #include "uart.h"
  11          
  12          #include "stdio.h"
  13          #include "string.h"
  14          #include "math.h"
  15          
  16          /*======variables and parameters======*/
  17          //Led
  18          pdata unsigned char Led_Buf[8] = {0,0,0,0,0,0,0,0};
  19          idata bit Led_1_Flag;
  20          idata unsigned char Led_1_Time_100ms;
  21          idata unsigned int Led_3_Time_3000ms;
  22          idata bit Flash_3 = 1;
  23          idata bit Relay_Now,Relay_Old;
  24          //Seg
  25          pdata unsigned char Seg_Buf[8] = {10,10,10,10,10,10,10,10};
  26          idata unsigned char Seg_Pos = 0;
  27          idata unsigned char Seg_Slow_Down;
  28          idata unsigned char Seg_Disp_Mode;//0-ÂùêÊ†áÁïåÈù¢ 1-ÈÄüÂ∫¶ÁïåÈù¢ 2-ÂèÇÊï∞ÁïåÈù¢
  29          //Key
  30          idata unsigned char Key_Val, Key_Old, Key_Up, Key_Down; // ÂàÜÂà´Â≠òÂÇ®ÂΩìÂâçÈîÆÂÄº„ÄÅÊóßÈîÆÂÄº„ÄÅÂºπËµ∑Èî
             -ÆÂÄº„ÄÅÊåâ‰∏ãÈîÆÂÄº
  31          idata unsigned char Key_Slow_Down;
  32          //Uart
  33          idata unsigned char Uart_Rec_Index;
  34          pdata unsigned char Uart_Rec_Buf[9] = 0;
  35          bit Uart_Rec_Falg;
  36          idata unsigned char Uart_Rec_Tick;
  37          //idata unsigned char Char_Read;
  38          idata unsigned char Result;
  39          //Frep
  40          idata unsigned int Frep;
  41          idata unsigned int Time_1s; 
  42          //variables
  43          idata unsigned char Moving_Mode;//0-Á©∫Èó≤ 1-ËøêË°å 2-Á≠âÂæÖ(Á≠âÂæÖ‰πãÂâçÂøÖÈ°ªÊòØËøêË°å)
  44          //parameters
  45          idata unsigned int x,y;
  46          idata unsigned int Location_Goal_x;
  47          idata unsigned int Location_Goal_y;
  48          idata unsigned int Location_Devi_x;
  49          idata unsigned int Location_Devi_y;
  50          idata unsigned int Location_x;
  51          idata unsigned int Location_y;
  52          idata bit Got_it_Flag;
  53          idata unsigned int Speed_x10;
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 2   

  54          idata float Speed;
  55          idata unsigned char Para_R_x10 = 10;
  56          idata char Para_B = 0;
  57          idata bit Para_Flag;//0-R 1-B
  58          idata float Distance_Devi_Goal,Distance_Devi_Goal_Init;
  59          idata unsigned int Timers;
  60          idata bit Move_Flag;
  61          idata float Distance_Devi_Goal_temp;
  62          idata bit Finish_Move;
  63          //Ultrasonic
  64          idata unsigned char Distance;
  65          idata unsigned char Distance_Slow_Down;
  66          idata unsigned char Distance_temp;
  67          idata bit Obsa_Flag;
  68          //AD_DA
  69          idata unsigned char AD_1_Data;
  70          idata unsigned char AD_DA_Slow_Down;
  71          idata bit Work_Time;//0-night 1-day
  72          /*======Task======*/
  73          void Task_Proc()
  74          {
  75   1        if(Moving_Mode == 1)
  76   1          Speed_x10 = (3.14*Para_R_x10*Frep/10) + Para_B;
  77   1        else
  78   1          Speed_x10 = 0;
  79   1        
  80   1        if(Distance < 30)
  81   1        {
  82   2          if(Moving_Mode == 1)
  83   2          {
  84   3            Moving_Mode = 2;
  85   3            Obsa_Flag = 1;
  86   3          }
  87   2        }
  88   1        else
  89   1          Obsa_Flag = 0;
  90   1        
  91   1        if(Moving_Mode == 1)
  92   1        {
  93   2          Speed = (3.14*Para_R_x10*Frep/100) + Para_B;
  94   2          Move_Flag = 1;
  95   2        }
  96   1        else
  97   1        {
  98   2          Speed = 0;
  99   2          Move_Flag = 0;
 100   2        }
 101   1        if(Got_it_Flag == 1)
 102   1        {
 103   2          Distance_Devi_Goal_temp = (Speed * Timers) / 1000.0;
 104   2          Location_Devi_x = Distance_Devi_Goal_temp*(Location_Goal_x / Distance_Devi_Goal_Init);
 105   2          Location_Devi_y = Distance_Devi_Goal_temp*(Location_Goal_y / Distance_Devi_Goal_Init);
 106   2          Location_x = abs(Location_Goal_x - Location_Devi_x);
 107   2          Location_y = abs(Location_Goal_y - Location_Devi_y);
 108   2          Distance_Devi_Goal_Init = sqrt(Location_Goal_x*Location_Goal_x+Location_Goal_y*Location_Goal_y);
 109   2          Distance_Devi_Goal = sqrt(Location_x*Location_x+Location_y*Location_y);
 110   2          
 111   2          if(Distance_Devi_Goal_temp >= Distance_Devi_Goal_Init)
 112   2          {
 113   3            Moving_Mode = 0;
 114   3            Finish_Move = 1;
 115   3            Timers = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 3   

 116   3            Flash_3 = 0;
 117   3          }
 118   2          else
 119   2            Finish_Move = 0;
 120   2        }
 121   1      }
 122          /*======Key======*/
 123          void Key_Proc()
 124          {
 125   1        // ÂáèÈÄüËÆ°Êï∞ÔºåÊØè10msËøõÂÖ•‰∏ÄÊ¨°ÔºåÂÆûÁé∞ÊåâÈîÆÊ∂àÊäñ
 126   1        if (Key_Slow_Down < 10) return;
 127   1        Key_Slow_Down = 0;
 128   1      
 129   1        // ËØªÂèñÂΩìÂâçÊåâÈîÆÁä∂ÊÄÅ
 130   1        Key_Val = Key_Read();
 131   1        // ÈÄöËøá‰ΩçËøêÁÆóËÆ°ÁÆóÂá∫ÂàöÂàöË¢´Êåâ‰∏ãÁöÑÈîÆÔºà‰∏ãÈôçÊ≤øÊ£ÄÊµãÔºâ
 132   1        Key_Down = Key_Val & (Key_Val ^ Key_Old);
 133   1        // ÈÄöËøá‰ΩçËøêÁÆóËÆ°ÁÆóÂá∫ÂàöÂàöË¢´ÂºπËµ∑ÁöÑÈîÆÔºà‰∏äÂçáÊ≤øÊ£ÄÊµãÔºâ
 134   1        Key_Up = ~Key_Val & (Key_Val ^ Key_Old);
 135   1        // Êõ¥Êñ∞ÊóßÈîÆÂÄºÔºå‰∏∫‰∏ã‰∏ÄÊ¨°Ê£ÄÊµãÂÅöÂáÜÂ§á
 136   1        Key_Old = Key_Val;
 137   1        
 138   1        switch(Key_Down)
 139   1        {
 140   2          case 4://ÂêØÂä®ÊåâÈîÆ
 141   2            if(Moving_Mode == 0)
 142   2            {
 143   3              if(Got_it_Flag == 1)
 144   3                Moving_Mode = 1;
 145   3            }
 146   2            else if(Moving_Mode == 2)
 147   2            {
 148   3              if(Obsa_Flag == 0)
 149   3                Moving_Mode = 1;
 150   3            }
 151   2          break;
 152   2          case 5://ÈáçÁΩÆÊåâÈîÆ
 153   2            if(Moving_Mode == 0)
 154   2            {
 155   3              Location_Devi_x = Location_Devi_y = 0;
 156   3              Timers = 0;
 157   3            }
 158   2          break;
 159   2          case 8://ÁïåÈù¢ÊåâÈîÆ
 160   2            Seg_Disp_Mode = (++Seg_Disp_Mode) % 3;
 161   2            if(Seg_Disp_Mode == 2)
 162   2              Para_Flag = 0;
 163   2          break;
 164   2          case 9://ÈÄâÊã©ÊåâÈîÆ
 165   2            if(Seg_Disp_Mode == 2)
 166   2              Para_Flag ^= 1;
 167   2          break;
 168   2          case 12://Âä†ÊåâÈîÆ
 169   2            if(Seg_Disp_Mode == 2)
 170   2            {
 171   3              if(Para_Flag)//B
 172   3              {
 173   4                Para_B += 5;
 174   4                if(Para_B == 95)
 175   4                  Para_B = -90;
 176   4              }
 177   3              else
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 4   

 178   3              {
 179   4                Para_R_x10++;
 180   4                if(Para_R_x10 == 21)
 181   4                  Para_R_x10 = 10;
 182   4              }
 183   3            }
 184   2          break;
 185   2          case 13://ÂáèÊåâÈîÆ
 186   2            if(Seg_Disp_Mode == 2)
 187   2            {
 188   3              if(Para_Flag)//B
 189   3              {
 190   4                Para_B -= 5;
 191   4                if(Para_B == -95)
 192   4                  Para_B = 90;
 193   4              }
 194   3              else
 195   3              {
 196   4                Para_R_x10--;
 197   4                if(Para_R_x10 == 9)
 198   4                  Para_R_x10 = 20;
 199   4              }
 200   3            }
 201   2          break;
 202   2        }
 203   1      }
 204          /*======Seg======*/
 205          void Seg_Proc()
 206          {
 207   1        if(Seg_Slow_Down < 60) return;
 208   1        Seg_Slow_Down = 0;
 209   1        
 210   1        switch(Seg_Disp_Mode)
 211   1        {
 212   2          case 0://ÂùêÊ†á
 213   2            Seg_Buf[0] = 12;
 214   2            if(Moving_Mode)//Á≠âÂæÖ or ËøêË°å
 215   2            {
 216   3              Seg_Buf[1] = (Location_Goal_x >= 100)?Location_Goal_x / 100 % 10:10;
 217   3              Seg_Buf[2] = (Location_Goal_x >= 10)?Location_Goal_x / 10 % 10:10;
 218   3              Seg_Buf[3] = Location_Goal_x % 10;
 219   3              Seg_Buf[4] = 11;
 220   3              Seg_Buf[5] = (Location_Goal_y >= 100)?Location_Goal_y / 100 % 10:10;
 221   3              Seg_Buf[6] = (Location_Goal_y >= 10)?Location_Goal_y / 10 % 10:10;
 222   3              Seg_Buf[7] = Location_Goal_y % 10;
 223   3            }
 224   2            else
 225   2            {
 226   3              Seg_Buf[1] = (Location_Devi_x >= 100)?Location_Devi_x / 100 % 10:10;
 227   3              Seg_Buf[2] = (Location_Devi_x >= 10)?Location_Devi_x / 10 % 10:10;
 228   3              Seg_Buf[3] = Location_Devi_x % 10;
 229   3              Seg_Buf[4] = 11;
 230   3              Seg_Buf[5] = (Location_Devi_y >= 100)?Location_Devi_y / 100 % 10:10;
 231   3              Seg_Buf[6] = (Location_Devi_y >= 10)?Location_Devi_y / 10 % 10:10;
 232   3              Seg_Buf[7] = Location_Devi_y % 10;
 233   3            }
 234   2          break;
 235   2          case 1://ÈÄüÂ∫¶
 236   2            Seg_Buf[0] = 13;
 237   2            Seg_Buf[2] = 10;
 238   2            if(Moving_Mode == 1)//ËøêË°å
 239   2            {
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 5   

 240   3              Seg_Buf[1] = 1;
 241   3              Seg_Buf[3] = (Speed_x10 >= 10000)?Speed_x10 / 10000 % 10:10;
 242   3              Seg_Buf[4] = (Speed_x10 >= 1000)?Speed_x10 / 1000 % 10:10;
 243   3              Seg_Buf[5] = (Speed_x10 >= 100)?Speed_x10 / 100 % 10:10;
 244   3              Seg_Buf[6] = (Speed_x10 >= 10)?Speed_x10 / 10 % 10 + '.':10 + '.';
 245   3              Seg_Buf[7] = Speed_x10 % 10;
 246   3            }
 247   2            else if(Moving_Mode == 0)//Á©∫Èó≤
 248   2            {
 249   3              Seg_Buf[1] = 2;
 250   3              Seg_Buf[3] = 11;
 251   3              Seg_Buf[4] = 11;
 252   3              Seg_Buf[5] = 11;
 253   3              Seg_Buf[6] = 11;
 254   3              Seg_Buf[7] = 11;
 255   3            }
 256   2            else//Á≠âÂæÖ
 257   2            {
 258   3              Seg_Buf[1] = 3;
 259   3              Seg_Buf[3] = 10;
 260   3              Seg_Buf[4] = 10;
 261   3              Seg_Buf[5] = (Distance >= 100)?Distance / 100 % 10:10;
 262   3              Seg_Buf[6] = (Distance >= 10)?Distance / 10 % 10:10;
 263   3              Seg_Buf[7] = Distance % 10;
 264   3            }
 265   2          break;
 266   2          case 2://ÂèÇÊï∞
 267   2            Seg_Buf[0] = 14;
 268   2            Seg_Buf[1] = 10;
 269   2            Seg_Buf[2] = Para_R_x10 / 10 % 10 + '.';
 270   2            Seg_Buf[3] = Para_R_x10 % 10;
 271   2            Seg_Buf[4] = 10;
 272   2            if(Para_B >= 0)
 273   2            {
 274   3              Seg_Buf[5] = 10;
 275   3              Seg_Buf[6] = (Para_B >= 10)?Para_B / 10 % 10:10;
 276   3              Seg_Buf[7] = Para_B % 10;
 277   3            }
 278   2            else
 279   2            {
 280   3              Seg_Buf[5] = (abs(Para_B) >= 10)?11:10;
 281   3              Seg_Buf[6] = (abs(Para_B) >= 10)?abs(Para_B) / 10 % 10:11;
 282   3              Seg_Buf[7] = abs(Para_B) % 10;
 283   3            }
 284   2          break;
 285   2        }
 286   1      }
 287          /*======Led======*/
 288          void Led_Proc()
 289          {
 290   1        //led1
 291   1        if(Moving_Mode == 0)
 292   1          Led_Buf[0] = 0;
 293   1        else if(Moving_Mode == 1)
 294   1          Led_Buf[0] = 1;
 295   1        else
 296   1          Led_Buf[0] = Led_1_Flag?1:0;
 297   1        //led2
 298   1        if(Moving_Mode == 1)
 299   1          Led_Buf[1] = Work_Time?0:1;
 300   1        else
 301   1          Led_Buf[1] = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 6   

 302   1        //led3
 303   1        if(Finish_Move)
 304   1          Led_Buf[2] = Flash_3?0:1;
 305   1      
 306   1        Relay_Now = (Moving_Mode == 1)?1:0;
 307   1        if(Relay_Now != Relay_Old)
 308   1        {
 309   2          Relay(Relay_Now);
 310   2          Relay_Old = Relay_Now;
 311   2        }
 312   1        
 313   1        Led_Disp(Led_Buf);
 314   1      }
 315          /*======AD_DA======*/
 316          void AD_DA()
 317          {
 318   1        if(AD_DA_Slow_Down < 140) return;
 319   1        AD_DA_Slow_Down = 0;
 320   1        
 321   1        AD_1_Data = AD_Read(0x41);
 322   1        Work_Time = (AD_1_Data > 1.2*51);
 323   1      }
 324          /*======Uart======*/
 325          void Uart_Proc()
 326          {
 327   1        if(Uart_Rec_Index == 0) return;
 328   1        if(Uart_Rec_Tick >= 10)
 329   1        {
 330   2          Uart_Rec_Falg = 0;
 331   2          Uart_Rec_Tick = 0;
 332   2          //ËÆæÁΩÆÁõÆÁöÑÂú∞ÂùêÊ†á
 333   2          if(Uart_Rec_Buf[0] == '(' && Uart_Rec_Buf[Uart_Rec_Index - 1] == ')')
 334   2          {
 335   3            Result = sscanf(Uart_Rec_Buf,"(%u,%u)%n",&x,&y);
 336   3            if(Result == 2)
 337   3            {
 338   4              if(Moving_Mode == 0)
 339   4              {
 340   5                Location_Goal_x = x;
 341   5                Location_Goal_y = y;
 342   5                Got_it_Flag = 1;
 343   5                printf("Got it");
 344   5              }
 345   4            }
 346   3          }
 347   2          //Êü•ËØ¢ËÆæÂ§áÁä∂ÊÄÅ
 348   2          else if(strcmp(Uart_Rec_Buf,"?") == 0)
 349   2          {
 350   3            if(Moving_Mode == 0)
 351   3              printf("Idle");
 352   3            else if(Moving_Mode == 2)
 353   3              printf("Wait");
 354   3            else
 355   3              printf("Busy");
 356   3          }
 357   2          //Êü•ËØ¢ËÆæÂ§á‰ΩçÁΩÆ
 358   2          else if(strcmp(Uart_Rec_Buf,"#") == 0)
 359   2            printf("(%u,%u)",Location_Devi_x,Location_Devi_y);
 360   2          else
 361   2            printf("Error");
 362   2          memset(Uart_Rec_Buf,0,Uart_Rec_Index);
 363   2          Uart_Rec_Index = 0;
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 7   

 364   2        }
 365   1      }
 366          /*======Ultrasonic======*/
 367          void Ultrasonic_Proc()
 368          {
 369   1        if(Distance_Slow_Down < 120) return;
 370   1        Distance_Slow_Down = 0;
 371   1        
 372   1        Distance_temp = Ultrasonic_Read();
 373   1        if(Distance_temp != 0)
 374   1          Distance = Distance_temp;
 375   1      }
 376          /*======Timer_0======*/
 377          void Timer0_Init(void)    //1ÊØ´Áßí@12.000MHz
 378          {
 379   1        AUXR &= 0x7F;     //ÂÆöÊó∂Âô®Êó∂Èíü12TÊ®°Âºè
 380   1        TMOD &= 0xF0;     //ËÆæÁΩÆÂÆöÊó∂Âô®Ê®°Âºè
 381   1        TMOD |= 0x05;
 382   1        TL0 = 0x00;       //ËÆæÁΩÆÂÆöÊó∂ÂàùÂßãÂÄº
 383   1        TH0 = 0x00;       //ËÆæÁΩÆÂÆöÊó∂ÂàùÂßãÂÄº
 384   1        TF0 = 0;        //Ê∏ÖÈô§TF0Ê†áÂøó
 385   1        TR0 = 1;        //ÂÆöÊó∂Âô®0ÂºÄÂßãËÆ°Êó∂
 386   1      }
 387          /*======Timer_1======*/
 388          void Timer1_Init(void)    //1ÊØ´Áßí@12.000MHz
 389          {
 390   1        AUXR &= 0xBF;     //ÂÆöÊó∂Âô®Êó∂Èíü12TÊ®°Âºè
 391   1        TMOD &= 0x0F;     //ËÆæÁΩÆÂÆöÊó∂Âô®Ê®°Âºè
 392   1        TL1 = 0x18;       //ËÆæÁΩÆÂÆöÊó∂ÂàùÂßãÂÄº
 393   1        TH1 = 0xFC;       //ËÆæÁΩÆÂÆöÊó∂ÂàùÂßãÂÄº
 394   1        TF1 = 0;        //Ê∏ÖÈô§TF1Ê†áÂøó
 395   1        TR1 = 1;        //ÂÆöÊó∂Âô®1ÂºÄÂßãËÆ°Êó∂
 396   1        ET1 = 1;        //‰ΩøËÉΩÂÆöÊó∂Âô®1‰∏≠Êñ≠
 397   1        EA = 1;
 398   1      }
 399          /*======Timer_1_Interrupt======*/
 400          void Timer1_Isr(void) interrupt 3
 401          {
 402   1        Key_Slow_Down++;
 403   1        Seg_Slow_Down++;
 404   1        Distance_Slow_Down++;
 405   1        AD_DA_Slow_Down++;
 406   1        Seg_Pos = (++Seg_Pos) % 8;
 407   1        if(Seg_Buf[Seg_Pos] > 20)
 408   1          Seg_Disp(Seg_Pos,Seg_Buf[Seg_Pos] - '.',1);
 409   1        else
 410   1          Seg_Disp(Seg_Pos,Seg_Buf[Seg_Pos],0);
 411   1        
 412   1        if(++Time_1s == 1000)
 413   1        {
 414   2          Time_1s = 0;
 415   2          Frep = (TH0 << 8)|TL0;
 416   2          TH0 = TL0 = 0;
 417   2        }
 418   1        if(Uart_Rec_Falg)
 419   1          Uart_Rec_Tick++;
 420   1        
 421   1        if(++Led_1_Time_100ms == 100)
 422   1        {
 423   2          Led_1_Time_100ms = 0;
 424   2          Led_1_Flag ^= 1;
 425   2        }
C51 COMPILER V9.60.7.0   MAIN                                                              06/15/2025 00:09:23 PAGE 8   

 426   1        if(Move_Flag)
 427   1          Timers++;
 428   1        if(Flash_3 == 0)
 429   1        {
 430   2          if(++Led_3_Time_3000ms == 3000)
 431   2          {
 432   3            Led_3_Time_3000ms = 0;
 433   3            Flash_3 = 1;
 434   3          }
 435   2        }
 436   1      }
 437          /*======Uart_Interrupt======*/
 438          void Uart1_Isr(void) interrupt 4
 439          {
 440   1        if(RI)        //Ê£ÄÊµã‰∏≤Âè£1Êé•Êî∂‰∏≠Êñ≠
 441   1        {
 442   2          Uart_Rec_Falg = 1;
 443   2          Uart_Rec_Tick = 0;
 444   2          Uart_Rec_Buf[Uart_Rec_Index++] = SBUF;
 445   2          RI = 0;     //Ê∏ÖÈô§‰∏≤Âè£1Êé•Êî∂‰∏≠Êñ≠ËØ∑Ê±Ç‰Ωç
 446   2          if(Uart_Rec_Index > 9)
 447   2          {
 448   3            memset(Uart_Rec_Buf,0,10);
 449   3            Uart_Rec_Index = 0;
 450   3          }
 451   2        }
 452   1      }
 453          
 454          /*======Main======*/
 455          void main()
 456          {
 457   1        System_Init();
 458   1        Timer0_Init();
 459   1        Uart1_Init();
 460   1        Timer1_Init();
 461   1        while(1)
 462   1        {
 463   2          Key_Proc();
 464   2          Seg_Proc();
 465   2          Led_Proc();
 466   2          AD_DA();
 467   2          Ultrasonic_Proc();
 468   2          Uart_Proc();
 469   2          Task_Proc();
 470   2        }
 471   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =   2520    ----
   CONSTANT SIZE    =     50    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =     25    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =     62    ----
   BIT SIZE         =     11    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
